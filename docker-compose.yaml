services:
  mongo:
    image: mongo:6
    ports:
      - "37017:27017"
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth:
    env_file:
      - ./auth/.env
    build: ./auth
    environment:
      - MONGODB_AUTH_URI=${MONGODB_AUTH_URI}
      - JWT_SECRET=${JWT_SECRET}
      - PORT=${AUTH_PORT}
    depends_on:
      - mongo
    ports:
      - "${AUTH_PORT}:3000"
    networks:
      - app-network
    restart: always

  product:
    env_file:
      - ./product/.env
    build: ./product
    environment:
      - MONGODB_PRODUCT_URI=${MONGODB_PRODUCT_URI}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - PORT=${PRODUCT_PORT}
    depends_on:
      - mongo
      - rabbitmq
    ports:
      - "${PRODUCT_PORT}:3001"
    networks:
      - app-network
    restart: always

  order:
    env_file:
      - ./order/.env
    build: ./order
    environment:
      - MONGODB_ORDER_URI=${MONGODB_ORDER_URI}
      - MONGODB_PRODUCT_URI=${MONGODB_PRODUCT_URI}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
      - JWT_SECRET=${JWT_SECRET}
      - PORT=${ORDER_PORT}
    depends_on:
      - mongo
      - rabbitmq
    ports:
      - "${ORDER_PORT}:3002"
    networks:
      - app-network
    restart: always

  api-gateway:
    build: ./api-gateway
    depends_on:
      - auth
      - product
      - order
    ports:
      - "${API_GATEWAY_PORT}:3003"
    networks:
      - app-network
    restart: always

  # (Tuỳ chọn) Chạy test API sau khi các service khởi động
  api-test:
    build: ./tests
    depends_on:
      - api-gateway
    networks:
      - app-network
    restart: "no"

networks:
  app-network:
    driver: bridge
